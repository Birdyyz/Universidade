---
title: "Exercícios de Regressão Logística"
author: ""
output: html_document
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
```


# Exercício 1 – Probabilidade de doença em função do tabagismo

Um estudo simples em saúde pública pretendeu perceber a relação entre **tabagismo** e uma determinada **doença respiratória crónica**. Foi recolhida informação sobre 300 indivíduos, guardada no ficheiro `saude_fumadores.csv`, com as seguintes variáveis:

* `doenca` – variável binária:

  * `1` se o indivíduo tem a doença respiratória crónica;
  * `0` caso contrário.
* `fumador` – variável binária:

  * `1` se o indivíduo é fumador atual;
  * `0` se não é fumador atual.
* `idade` – idade do indivíduo (em anos).
* `sexo` – variável categórica com dois níveis: `"F"` e `"M"`.

Pretende-se ajustar um **modelo de regressão logística** para estudar a associação entre tabagismo e doença respiratória, controlando o efeito da idade.

## 1.1 Importação e exploração inicial

1. Leia o ficheiro `saude_fumadores.csv` para R e faça uma breve inspeção dos dados.

```{r}
head(saude_fumadores)
dim(saude_fumadores)
names(saude_fumadores)
summary(saude_fumadores)
```

2. Produza algumas tabelas e gráficos exploratórios simples, por exemplo:

   * tabela de frequências de `doenca` e `fumador`;
   * gráfico de barras cruzando `doenca` e `fumador`;
   * boxplot de `idade` por `doenca`.

Comente **pelo menos duas observações** interessantes (por exemplo, se a doença parece mais frequente em fumadores, se os doentes são em média mais velhos, etc.).

```{r}
table(saude_fumadores$doenca)
n <- 300
table(saude_fumadores$doenca)/n

ggplot(saude_fumadores, aes(x = fumador, y = doenca))+
  geom_bar(stat = "identity", fill = "gray", color= "black")



ggplot(saude_fumadores, aes(x = factor(doenca), y = idade)) +
  geom_boxplot(fill="gray")
```

## 1.2 Modelo de regressão logística simples

3. Comece por ajustar um modelo de regressão logística com:

$$
\text{Resposta: }\texttt{doenca}, \quad \text{Covariável: }\texttt{fumador}
$$

isto é, um modelo com **apenas uma covariável** (`fumador`).

```{r}
modelo <- glm(doenca~fumador, data = saude_fumadores,
          family = binomial(link = "logit"))

summary(modelo)

"""
a variavel fumador é significativa (tem estrela)
influência -> como o sinal é positivo, um individuo q é fumador tem maior probabilidade de ter a doença

0.8848 -> saber impacto real em termos de quantidade ->  variavel categorica, um fumador tem e^B1 maior odds de ter a doença do que um individuo não fumador
"""
```

4. Interprete:

   a) O **sinal** do coeficiente associado a `fumador`.
   b) O **p-valor** associado a esse coeficiente.

   Com base nessa informação, discuta se existe evidência estatística de associação entre tabagismo e doença respiratória.

5. Calcule a **odds ratio** associada à variável `fumador` (fumadores vs. não fumadores) usando o coeficiente do modelo.
   Interprete em linguagem simples.

```{r}
odds_ratio = exp(0.8848)
odds_ratio
```

## 1.3 Modelo de regressão logística múltipla

6. Ajuste agora um modelo mais completo, incluindo a idade:

$$
\texttt{doenca} \sim \texttt{fumador} + \texttt{idade}
$$

```{r}
modeloc <- glm(doenca~fumador+idade,data = saude_fumadores,
            family= binomial(link = "logit"))
summary(modeloc)
"""
o coeficiente aumentou ligeiramente ao incluir a variável idade
quanto mais velho e fumar maior a probabilidade de ter doença

idade aumenta uma unidade a odds de ter uma doença aumenta e^(0.06305)

"""
modelo3 <- glm(doenca~fumador:idade,data = saude_fumadores, family = binomial)
summary(modelo3)
"""
muito significativa (3 estrelas) e sinal positivo
"""
```

7. Compare os modelos `mod1` e `mod2`:

   a) Comente se o coeficiente de `fumador` mudou muito ao incluir a variável `idade`.
   b) Discuta o que significa, em termos de interpretação, “o efeito de ser fumador **ajustado** à idade”.

8. Usando o modelo `mod2`, calcule a probabilidade prevista de ter a doença para os seguintes perfis:

   * Perfil A: não fumador, 30 anos;
   * Perfil B: fumador, 30 anos;
   * Perfil C: não fumador, 60 anos;
   * Perfil D: fumador, 60 anos.

```{r}
predict(modeloc, newdata = data.frame(fumador = 0, idade=30),type="response")
predict(modeloc, newdata = data.frame(fumador = 1, idade=30),type="response")
predict(modeloc, newdata = data.frame(fumador = 0, idade=60),type="response")
predict(modeloc, newdata = data.frame(fumador = 1, idade=60),type="response")

"""
maior a idade e se fumar aumenta a probabilidade de doença
"""
```

Comente os resultados: em que medida a idade e o tabagismo contribuem para aumentar a probabilidade de doença?

## 1.4 Avaliação simples do modelo

9. A partir do modelo `mod2`, obtenha as probabilidades previstas para todos os indivíduos na amostra e transforme-as em **previsões 0/1**, usando um ponto de corte de 0.5.

10. Construa a **matriz de confusão** e calcule a **proporção de classificações corretas** (acerto global). Comente se considera este valor razoável, tendo em conta o contexto.

```{r}
saude_fumadores$prob_manual <- predict(modeloc, type = "response")
saude_fumadores

saude_fumadores$doenca_pred <- ifelse(saude_fumadores$prob_manual >= 0.5, 1, 0)
saude_fumadores

table(Real = saude_fumadores$doenca, Predito = saude_fumadores$doenca_pred)
# proporçao de acerto:
271/300
# indice de Youden
```

11. (Questão conceptual) Discuta uma **limitação** de usar apenas o ponto de corte 0.5 e a percentagem de acerto para avaliar um modelo de regressão logística (por exemplo, em situações em que a doença é rara).

---

# Exercício 2 – Aprovação de alunos em função dos hábitos de estudo

Numa disciplina de Estatística, foi recolhida informação sobre 200 alunos, guardada no ficheiro `alunos_aprovacao.csv`. As variáveis são:

* `aprovado` – variável binária:

  * `1` se o aluno foi aprovado na disciplina;
  * `0` se foi reprovado.
* `horas_estudo` – número médio de horas de estudo por semana.
* `frequencia_aulas` – percentagem de aulas assistidas (entre 0 e 100).
* `trabalhador` – variável binária:

  * `1` se o aluno trabalha em part-time;
  * `0` caso contrário.
* `media_secundario` – média final (0–20) obtida no ensino secundário.

Pretende-se ajustar modelos de regressão logística para estudar os fatores associados à aprovação.

## 2.1 Importação e exploração dos dados

1. Leia o ficheiro `alunos_aprovacao.csv` e faça uma breve exploração descritiva:

   * tabelas de frequências para `aprovado` e `trabalhador`;
   * estatísticas resumo para `horas_estudo`, `frequencia_aulas` e `media_secundario`;
   * um ou dois gráficos sugeridos por si (por exemplo, boxplot de `horas_estudo` por `aprovado`).

```{r exercicio2-importacao}
dados <- alunos_aprovacao
summary(dados)
# tabela de frequencias
table(dados$aprovado)
table(dados$trabalhador)
table(dados$aprovado, dados$trabalhador)

# estatisticas resumo
summary(dados$horas_estudo,dados$frequencia_aulas,dados$media_secundario)

library(ggplot2)
ggplot(dados, aes(x = aprovado, y = horas_estudo)) +
  geom_boxplot(fill = "gray")

ggplot(dados, aes(x = aprovado, y = horas_estudo)) +
  geom_line()
```

Comente **duas observações** sobre o comportamento dos alunos (por exemplo, se os aprovados tendem a estudar mais, se há grandes diferenças na frequência às aulas, etc.).

Como podemos ver por ambos os gráficos, os aprovados tendem a estudar mais do que os não aprovados

## 2.2 Modelo logístico com múltiplas covariáveis

2. Ajuste um modelo de regressão logística com:

$$
\texttt{aprovado} \sim \texttt{horas_estudo} + \texttt{frequencia_aulas} + \texttt{trabalhador}
$$

```{r exercicio2-logistico1}
modeloap <- glm(aprovado~horas_estudo + frequencia_aulas + trabalhador, data = dados,family = binomial(link = "logit"))
summary(modeloap)
```

3. Interprete:

   a) Os sinais dos coeficientes de `horas_estudo` e `frequencia_aulas`.
   horas_estudo -> 0.035405
   por cada hora a mais de estudo aumenta 0.035405 unidades de aprovado
   frequencia_aulas -> 0.002489
   insignificante, nao altera muito aos aprovados
   
   b) Os respetivos p-valores.
  horas_estudo -> Significativo (p < 0.01). Há evidência de que horas de estudo influenciam aprovado.
  frequencia_aulas -> Não significativo. Não há evidência de efeito.
  
   Com base nisso, discuta se estes fatores parecem estar associados à probabilidade de aprovação.

O unico fator que esta relacionado à provabilidade de aprovação sao as horas_estudo 

4. Calcule e interprete a **odds ratio** para a variável `trabalhador`:

   * `trabalhador = 1` vs. `trabalhador = 0`,
     mantendo constantes as restantes variáveis.

```{r exercicio2-oddsratio-trabalhador}
exp(coef(modeloap))["trabalhador"]
```

Comente se trabalhar em part-time parece estar associado a maior ou menor probabilidade de aprovação.
OR = 0.772 (aproximadamente)

Isso significa que, mantendo constantes horas de estudo e frequência de aulas, ser trabalhador está associado a odds de aprovação cerca de 23% menores do que não ser trabalhador.

Cálculo: 
1−0.772 = 0.223 ≈ 23%
1−0.772= 0.228≈23% de redução nas odds.

Trabalhadores têm menor probabilidade de aprovação em relação a não trabalhadores, controlando as outras variáveis.

## 2.3 Inclusão da média do secundário

5. Ajuste agora um modelo mais completo com todas as covariáveis:

$$
\texttt{aprovado} \sim \texttt{horas_estudo} + \texttt{frequencia_aulas} + \texttt{trabalhador} + \texttt{media_secundario}
$$

```{r exercicio2-logistico2}
modelomc <- glm(aprovado ~ horas_estudo + frequencia_aulas + trabalhador + media_secundario , data = dados,family = binomial(link = "logit"))
summary(modelomc)
```

6. Compare `mod_alunos1` e `mod_alunos2`:

Neste modelo temos variáveis mais significativas relacionado à aprovação

   a) Comente se a inclusão de `media_secundario` altera o coeficiente (e/ou significância) de alguma das outras variáveis.
   
   Alterou o coeficiente de horas_estudo e esta ficou ainda mais significativa que antes
   A varivel de frequencia de aulas mudou mas continua a nao ser explicativa
   
   
   A inclusão de media_secundario alterou apenas ligeiramente o coeficiente de horas_estudo, tornando-o ainda mais significativo. As restantes variáveis (frequencia_aulas e trabalhador) mantiveram-se não significativas, pelo que a principal alteração foi a introdução da própria variável media_secundario como um preditor significativo.
   
   b) Discuta o que significa, neste contexto, interpretar o efeito de `horas_estudo` **ajustado** à média do secundário.
   
   
Interpretar o efeito de horas_estudo ajustado à média do secundário significa avaliar o impacto das horas de estudo na aprovação, mantendo constante a média do secundário. Assim, o modelo compara alunos com igual desempenho prévio, isolando o efeito específico das horas de estudo. Como o coeficiente se mantém significativo, concluímos que estudar mais aumenta a probabilidade de aprovação independentemente da média obtida no secundário.


## 2.4 Probabilidades previstas para perfis de alunos

7. Usando o modelo `mod_alunos2`, calcule as probabilidades previstas de aprovação para os seguintes perfis:

   * Perfil 1: `horas_estudo = 2`, `frequencia_aulas = 60`, `trabalhador = 1`, `media_secundario = 12`.
   * Perfil 2: `horas_estudo = 8`, `frequencia_aulas = 90`, `trabalhador = 0`, `media_secundario = 12`.
   * Perfil 3: `horas_estudo = 5`, `frequencia_aulas = 80`, `trabalhador = 0`, `media_secundario = 17`.

```{r exercicio2-probabilidades}
predict(modelomc, newdata = data.frame(horas_estudo  = 2, frequencia_aulas =60, trabalhador  = 1, media_secundario = 12),type="response")
predict(modelomc, newdata = data.frame(horas_estudo  = 8, frequencia_aulas =90, trabalhador  = 0, media_secundario = 12),type="response")
predict(modelomc, newdata = data.frame(horas_estudo  = 5, frequencia_aulas =80, trabalhador  = 0, media_secundario = 17),type="response")
```

Comente os resultados, discutindo:

* o impacto das horas de estudo e da frequência às aulas;
* o papel da média do secundário;
* se faz sentido que alunos com melhor média no secundário tenham, em geral, maior probabilidade de aprovação.

  Podemos ver o ultimo aluno tem a maior taxa de probabilidade de aprovação comparado aos outros dois. O perfil 3 tem uma nota do secundario alta, nao é aluno trabalhador, e mesmo com menos 3 horas de estudo comparado ao perfil 2 a probabildade de aprovacao aumenta 13%.
  O perfil 1, é o que tem menos chances de aprovação, estuda pouco, dos 3 é o que menos frequenta as aulas, é trabalhador e a media do secundario e de 12
  O perfil 2, estuda mais 6 horas que o primeiro, frequenta mais aulas q o dois e que o tres e tambem nao e trabalhador, mesmo com a mesma media do secundario que o primeiro a sua taxa é de 25% enquanto que o do primeiro é de 2%
## 2.5 Avaliação e pensamento crítico

8. Obtenha as probabilidades previstas de aprovação para todos os alunos e construa uma matriz de confusão usando o ponto de corte 0.5. Calcule a proporção de classificações corretas.

```{r exercicio2-avaliacao}
dados$prob_aprovacao <- predict(modelomc, type = "response")
dados$aprov_pred <- ifelse(dados$prob_aprovacao >= 0.5, 1, 0)
cm <- table(Real = dados$aprovado, Predito = dados$aprov_pred)
cm

TP <- cm["1","1"]
FN <- cm["1","0"]
FP <- cm["0","1"]
TN <- cm["0","0"]

sensibilidade <- TP / (TP + FN)

especificidade <- TN / (TN + FP)

sensibilidade
especificidade

```

9. Discuta, em texto, as seguintes questões:

   a) A taxa de acerto parece satisfatória? Porquê?
   
   O modelo acerta muito bem os reprovados, mas falha completamente nos aprovados.
   
   b) O modelo está a errar mais frequentemente nos aprovados ou nos reprovados? Que implicações isso poderia ter em termos de decisão (por exemplo, identificar alunos em risco)?
   
   O modelo é bom em identificar quem está em risco (os reprovados) → isso é positivo se o objetivo é detetar alunos que podem falhar.
   
   c) Sugira **uma alteração possível** ao modelo ou à forma como é avaliado (por exemplo, considerar outro ponto de corte, incluir uma interação, recolher uma nova variável) e justifique por que poderia ser útil.
   
   
Uma alteração possível é considerar um ponto de corte menor do que 0.5 para a classificação das probabilidades previstas. Isto aumentaria a sensibilidade do modelo, permitindo identificar melhor os alunos que serão aprovados, sem comprometer significativamente a identificação dos alunos em risco. Alternativamente, poderíamos incluir interações ou recolher variáveis adicionais que captem fatores importantes para a aprovação, como motivação ou participação em atividades extracurriculares.
