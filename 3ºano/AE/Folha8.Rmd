---
title: "Exercícios — Regressão Logística (R)"
author: ""
date: "`r format(Sys.Date(), '%d %B %Y')`"
output: html_document
editor_options:
  chunk_output_type: console
---
```{r E1-dados, eval=FALSE}
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
set.seed(123)
```

# -------------------------------------------------------------
# Exercício 1 — Sobrevivência no Titanic (modelo simples com treino/teste)

Use o conjunto de dados `titanic_train` do package **titanic**, contendo variáveis como `Survived`, `Pclass`, `Sex`, `Age` e `Fare`.

```{r E2-dados, eval=FALSE}
library(titanic)
library(dplyr)

dados_titanic <- titanic_train %>%
  select(Survived, Pclass, Sex, Age, Fare) %>%
  na.omit()

dados_titanic$Sex <- factor(dados_titanic$Sex, levels = c("male", "female"))

```


1. Separe os dados em treino (80%) e teste (20%). Explique porque não se deve avaliar o desempenho do modelo nos mesmos dados usados para o ajustar.
```{r E3-dados, eval=FALSE}
set.seed(123)
idx <- sample(seq_len(nrow(dados_titanic)), size = round(0.8 * nrow(dados_titanic)))
titanic_treino <- dados_titanic[idx,]
titanic_teste <- dados_titanic[-idx,]


```
2. Ajuste, **apenas nos dados de treino**, o modelo:

$$
\operatorname{logit}\Big(
P(\text{Survived}=1 \mid \text{Pclass}, \text{Sex}, \text{Age}, \text{Fare})
\Big)
=
\beta_0
+ \beta_1\,\text{Pclass}
+ \beta_2\,\text{Sex}
+ \beta_3\,\text{Age}
+ \beta_4\,\text{Fare}.
$$

   Interprete:
   - o sinal de $\beta_1$ (classe),
   - o sinal e significância de $\beta_2$ (sexo).
```{r E4-dados, eval=FALSE}
modelo <- glm(Survived ~ Pclass + Sex + Age + Fare , data = titanic_treino,
              family = binomial)
summary(modelo)
```
3. Usando o **conjunto de teste**,

```{r E5-dados, eval=FALSE}
prob_teste <- predict(modelo, newdata = titanic_teste, type = "response")
head(prob_teste)

```
calcule as probabilidades previstas $\hat p_i$.  
   Com threshold $t = 0.5$
```{r E6-dados, eval=FALSE}

pred_class <- ifelse(prob_teste >= 0.5,1,0)

tab <- table(
  Observado = titanic_teste$Survived,
  Previsto = pred_class
)
tab
```
construa a matriz de confusão e calcule:
   - accuracy,  
   - sensibilidade (TPR),  
   - especificidade (TNR).

```{r E7-dados, eval=FALSE}
TP <- tab["1","1"]
TN <- tab["0","0"]
FP <- tab["0","1"]
FN <- tab["1","0"]

accuracy <- (TP+TN) / sum(tab)
sens <- TP / (TP+FN)
espec <- TN / (TN + FP)

```
4. Com a package `pROC`, obtenha a **curva ROC** e a **AUC**.  
   Interprete a AUC.


```{r E8-dados, eval=FALSE}
library(pROC)

roc_titanic <- roc(
  response = dados_titanic$Survived,
  predictor = prob_teste
)
plot(roc_titanic, main = "Curva ROC - Titanic (teste)")
auc(roc_titanic)
```

---

# -------------------------------------------------------------
# Exercício 2 — Crédito ao consumo (`Default`, ISLR2)

```{r E9-dados, eval=FALSE}
library(ISLR2)
dados_default <- Default
```

Considere modelar a probabilidade de **incumprimento** (default = "Yes").

1. Crie $Y = 1$ se `default="Yes"`, $Y=0$ caso contrário.  
   Explique por que a regressão logística é adequada (e a regressão linear não).
```{r E10-dados, eval=FALSE}
dados_default$Y <- ifelse(dados_default$default == "Yes", 1, 0)
table(dados_default$Y)
```
2. Divida os dados em **treino (60%)** e **teste (40%)**.  
   Compare a proporção de incumpridores nos dois conjuntos.
```{r E11-dados, eval=FALSE}
set.seed(123)
idx <- sample(seq_len(nrow(dados_default)), size = round(0.6 * nrow(dados_default)))
default_treino <- dados_default[idx,]
default_teste <- dados_default[-idx,]
summary(default_treino)
summary(default_teste)
```
3. Ajuste o modelo:

$$
\operatorname{logit}\Big(
P(Y=1 \mid \text{balance}, \text{income}, \text{student})
\Big)
=
\beta_0
+ \beta_1\,\text{balance}
+ \beta_2\,\text{income}
+ \beta_3\,\text{student}.
$$

   Interprete:
   - o sinal de $\beta_1$ (saldo),
   - o efeito de ser estudante ($\beta_3$),
   - o significado de $\exp(\beta_1)$ e $\exp(\beta_3)$ como *odds ratios*.
```{r E12-dados, eval=FALSE}
modelo_default <- glm(Y ~ balance + income + student , data = default_treino,
              family = binomial)
summary(modelo_default)

```
4. Usando o modelo, calcule previsões no **teste** com threshold $t=0.5$

```{r E20-dados, eval=FALSE}
pred_prob <- predict(modelo_default, type = "response")
prev_modelo <- ifelse(pred_prob >= 0.5, 1, 0)

tabela <- table(
  Observado = modelo_default$y,
  Previsto = prev_modelo
)
tabela
```

e obtenha:  
   - matriz de confusão,  
   - sensibilidade,  
   - especificidade.  
   Comente tendo em conta o risco financeiro de falsos negativos.
```{r E13-dados, eval=FALSE}
TP <- tab["1","1"]
TN <- tab["0","0"]
FP <- tab["0","1"]
FN <- tab["1","0"]

accuracy <- (TP+TN) / sum(tabela)
sens <- TP / (TP+FN)
espec <- TN / (TN + FP)

```
5. Produza a curva ROC, AUC e determine um threshold ótimo pelo **índice de Youden**.  
   Compare o desempenho entre $t=0.5$ e o threshold ótimo.
```{r E14-dados, eval=FALSE}
roc_default <- roc(
  response = dados_default$Y,
  predictor = pred_prob
)

plot(roc_default, main = "Curva ROC - Default")
auc(roc_default)

```
---

